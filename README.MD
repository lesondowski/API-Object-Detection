# API ph√°t hi·ªán v·∫≠t th·ªÉ (YOLOv11) üîß

**M√¥ t·∫£ ng·∫Øn:**
API ph√°t hi·ªán v·∫≠t th·ªÉ s·ª≠ d·ª•ng m√¥ h√¨nh YOLO (PyTorch / ONNX) v√† FastAPI. Nh·∫≠n ƒë·∫ßu v√†o l√† danh s√°ch URL ·∫£nh, tr·∫£ v·ªÅ c√°c v·∫≠t th·ªÉ ƒë∆∞·ª£c ph√°t hi·ªán (s·ªë l∆∞·ª£ng, bounding box/segmentation theo m√¥ h√¨nh).

---

## üîé ƒêi·ªÉm n·ªïi b·∫≠t
- H·ªó tr·ª£ c·∫£ m√¥ h√¨nh **PyTorch (.pt)** v√† **ONNX (.onnx)**
- API ƒë∆°n gi·∫£n: POST `/predict/` v·ªõi payload ch·ª©a `image_urls`
- H·ªó tr·ª£ ph√¢n lo·∫°i theo **portion** (v√≠ d·ª•: "Lon & Chai", "Th√πng H√†ng", "Kh·ªëi H√†ng")

---

## üìÅ C·∫•u tr√∫c d·ª± √°n (ch·ªâ m·ª•c ch√≠nh)
- `api/` ‚Äî FastAPI app
  - `main.py` ‚Äî entrypoint (app)
  - `routers/predict_router.py` ‚Äî endpoint `/predict/`
  - `schemas/request_model.py` ‚Äî model request (Pydantic)
- `models/predict.py` ‚Äî logic load ·∫£nh v√† g·ªçi model (detect/segment)
- `api/files/model/` ‚Äî ch·ª©a m√¥ h√¨nh (.pt, .onnx, tflite)
- `utils_cf/config.py` ‚Äî c·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n m√¥ h√¨nh, DEVICE
- `requirements.txt` ‚Äî dependencies

---

## ‚öôÔ∏è Y√™u c·∫ßu
- Python >= 3.10  
- G√≥i (c√≥ trong `requirements.txt`): `fastapi`, `uvicorn`, `ultralytics`, `onnxruntime`, `opencv-python`, `numpy`, `requests`, `Pillow`, `loguru`, v.v.

C√†i ƒë·∫∑t:

```bash
pip install -r requirements.txt
```

---

## üõ† C·∫•u h√¨nh nhanh
File `utils_cf/config.py` ch·ª©a:

```python
DEVICE = "cuda" if torch.cuda.is_available() else "cpu"
MODEL_OD_PT = "api/files/model/pt/ADYL11m.pt"
MODEL_IS_ONNX = "api/files/model/onnx/AD_YL11s_Seg_1.80.onnx"
MODEL_BLOCK_PT = "api/files/model/pt/AD_Productblock_YL11.pt"
```
- Thay ƒë∆∞·ªùng d·∫´n n·∫øu mu·ªën d√πng m√¥ h√¨nh kh√°c.
- `DEVICE` t·ª± ph√°t hi·ªán GPU (n·∫øu torch c√≥ CUDA), b·∫°n c√≥ th·ªÉ √©p v·ªÅ `"cpu"` khi c·∫ßn.

---

## ‚ñ∂Ô∏è Ch·∫°y API
Kh·ªüi ch·∫°y server (m·∫∑c ƒë·ªãnh port 10000 trong c·∫•u h√¨nh hi·ªán t·∫°i):

```bash
uvicorn api.main:app --host 0.0.0.0 --port 10000
```
Truy c·∫≠p g·ªëc: `GET /` (tr·∫£ v·ªÅ th√¥ng b√°o server ƒëang ch·∫°y)

---

## üì® Endpoint ch√≠nh

**POST** `/predict/`  
Body (JSON):

```json
{
  "image_urls": ["https://example.com/image1.jpg", "https://example.com/image2.jpg"],
  "conf_input": 0.24,
  "iou_input": 0.2,
  "portion": "Lon & Chai",
  "repuirements_count": 1
}
```
- `image_urls`: danh s√°ch URL ·∫£nh (b·∫Øt bu·ªôc)
- `conf_input`: confidence threshold (m·∫∑c ƒë·ªãnh ~0.24)
- `iou_input`: IOU threshold (m·∫∑c ƒë·ªãnh ~0.2)
- `portion`: t√™n l·ªõp t·ªïng h·ª£p (v√≠ d·ª• "Lon & Chai", "Th√πng H√†ng", ...)
- `repuirements_count`: s·ªë l∆∞·ª£ng y√™u c·∫ßu ƒë·ªÉ ƒë∆∞·ª£c xem l√† "ƒê·∫°t"

V√≠ d·ª• tr·∫£ v·ªÅ (c·∫•u tr√∫c m·∫´u):

```json
{
  "results": [
    { "API URL IMAGE": "https://.../img1.jpg", "Lon & Chai": 2, "OtherClass": 1 },
    { "S·ªë L∆∞·ª£ng": 2, "K·∫øt Qu·∫£": "ƒê·∫°t", "L√Ω Do": "" }
  ]
}
```

---

## üßæ M√¥ h√¨nh k√®m theo (v√≠ d·ª• c√≥ trong repo)
- PT: `api/files/model/pt/ADYL11m.pt`, `AD_Productblock_YL11.pt`, ...
- ONNX: `api/files/model/onnx/AD_YL11s_Seg_1.80.onnx`, ...
- TFLite (saved models) n·∫±m trong `api/files/model/tflite/...`

---

## üí° Ghi ch√∫ & h∆∞·ªõng d·∫´n g·ª° l·ªói
- N·∫øu l·ªói t·∫£i ·∫£nh: ki·ªÉm tra URL (m√£ tr·∫£ v·ªÅ 200). H√†m `load_image_from_url` s·∫Ω n√©m HTTPException n·∫øu t·∫£i th·∫•t b·∫°i.
- N·∫øu mu·ªën ch·∫°y ho√†n to√†n tr√™n CPU: √©p `DEVICE = "cpu"` trong `utils_cf/config.py`.
- Khi d√πng ONNX, c·∫ßn `onnxruntime` ƒë∆∞·ª£c c√†i ƒë·∫∑t.
